"use strict";app.controller("MypageCtrl",["$scope","$rootScope","$routeParams","$controller","$location","$log","userModel","workProposesModel","worksModel","proposeOkMessageModel","userService",function($scope,$rootScope,$routeParams,$controller,$location,$log,userModel,workProposesModel,worksModel,proposeOkMessageModel,userService){if($controller("AbstractCtrl",{$scope:$scope}),$log.debug("MypageCtrl Start"),$scope.errors=null,$scope.displayMessages="",$scope.userModel=userModel.user.get(),$scope.workProposes=workProposesModel.workProposes.get(),$scope.works=worksModel.works.get(),$scope.tabKbn=1,$scope.$on("changedUser",function(){$scope.userModel=userModel.user.get()}),$scope.$on("changedWorkProposes",function(){$scope.workProposes=workProposesModel.workProposes.get()}),$scope.$on("changedWorks",function(){$scope.works=worksModel.works.get()}),$scope.updateUser=function(userModel){$scope.errors=null,$scope.displayMessages="",$scope.showProgressModal(),userModel.birthday=$("#userModel_birthday").val(),userService.updateUser(userModel).success(function(){$scope.hideProgressModal(),$scope.displayMessages="\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f\u3002",$("body,html").animate({scrollTop:0},"slow")}).error(function(data){$scope.hideProgressModal();var messages=[];$scope.errors=data,$scope.setErrorMessage(data.email,"\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9",messages),$scope.setErrorMessage(data.current_password,"\u73fe\u5728\u306e\u30d1\u30b9\u30ef\u30fc\u30c9",messages),$scope.setErrorMessage(data.password,"\u5909\u66f4\u30d1\u30b9\u30ef\u30fc\u30c9",messages),$scope.setErrorMessage(data.display_name,"\u8868\u793a\u540d",messages),$scope.setErrorMessage(data.birthday,"\u751f\u5e74\u6708\u65e5",messages),$scope.setErrorMessage(data.error_message,"",messages),$scope.displayMessages=$scope.getMessage(messages),$("body,html").animate({scrollTop:0},"slow")})},$scope.doLogout=function(){userService.logoutUser().success(function(data){$scope.resetCsrf(data),$("#modal-profile").modal("hide"),$scope.changeLogin(!1),$location.path("/")}).error(function(){})},$scope.doOkPropose=function(propose){var proposeOkMessage=proposeOkMessageModel.proposeOkMessage.getInitModel();proposeOkMessage.item_id=propose.item_id,proposeOkMessage.receive_user_id=propose.create_user_id,proposeOkMessageModel.proposeOkMessage.set(proposeOkMessage),$("#modal-propose-ok-message").modal("show")},$scope.getOkProposeString=function(okFlg){return void 0==okFlg||"1"!=String(okFlg)?"\u63d0\u6848\u306b\u5408\u610f\u3059\u308b":"\u63d0\u6848\u306b\u5408\u610f\u6e08\u307f"},$scope.checkWorkCategory=function(value){if(void 0==$scope.userModel.work_categories||null==$scope.userModel.work_categories||void 0==$scope.userModel.work_categories.length||0==$scope.userModel.work_categories.length){$scope.userModel.work_categories=[];var workCategory=userModel.user.getUserWorkCategories();return workCategory.name_id=value,$scope.userModel.work_categories.push(workCategory),$log.debug("checkWorkCategory first add "+value),void $log.debug("checkWorkCategory first add "+JSON.stringify($scope.userModel.work_categories))}var isExists=!1;if(angular.forEach($scope.userModel.work_categories,function(category,i){return void 0!=category.name_id&&String(category.name_id)==String(value)?($scope.userModel.work_categories.splice(i,1),$log.debug("checkWorkCategory del "+value),$log.debug("checkWorkCategory del "+JSON.stringify($scope.userModel.work_categories)),void(isExists=!0)):void 0}),!isExists){var workCategory=userModel.user.getUserWorkCategories();workCategory.name_id=value,$scope.userModel.work_categories.push(workCategory),$log.debug("checkWorkCategory end add "+value),$log.debug("checkWorkCategory end add "+JSON.stringify($scope.userModel.work_categories))}},$scope.isCheckWorkCategory=function(value){if(void 0==$scope.userModel||void 0==$scope.userModel.work_categories||null==$scope.userModel.work_categories||void 0==$scope.userModel.work_categories.length||0==$scope.userModel.work_categories.length)return!1;var isExists=!1;return angular.forEach($scope.userModel.work_categories,function(category){return void 0!=category.name_id&&String(category.name_id)==String(value)?void(isExists=!0):void 0}),isExists},$scope.getCheckWorkCategories=function(){if(void 0==$scope.userModel||void 0==$scope.userModel.work_categories||null==$scope.userModel.work_categories||void 0==$scope.userModel.work_categories.length||0==$scope.userModel.work_categories.length)return"(\u9078\u629e\u3055\u308c\u3066\u3044\u307e\u305b\u3093)";var categories="";return categories+="\u4e0b\u8a18\u306e\u4ed5\u4e8b\u30ab\u30c6\u30b4\u30ea\u304c\u9078\u629e\u3055\u308c\u3066\u3044\u307e\u3059",angular.forEach($scope.userModel.work_categories,function(category){categories+="\xa5n",categories+="("+$scope.getWorkKbnName(String(category.name_id))+")"}),categories},$scope.selectImage=function(){$rootScope.uploadKbn=1,$("#avatar").click()},$rootScope.chageUploadImage=function(){$scope.userModel.img_path="/assets/img-loading.gif",$("#upload-submit").click()},$rootScope.uploadComplete=function(content){$scope.userModel.img_path=content.img_path,$scope.userModel.img_file_name=content.img_file_name,$scope.userModel.tmp_img_path=content.tmp_img_path,$scope.userModel.tmp_file_name=content.tmp_file_name},$scope.getAge=function(){if(void 0==$scope.userModel||void 0==$scope.userModel.birthday||null==$scope.userModel.birthday||""==$scope.userModel.birthday)return"\u5e74\u9f62\u8868\u793a";if(!$scope.checkDate($scope.userModel.birthday))return"\u5e74\u9f62\u8868\u793a";var today=new Date;today=1e4*today.getFullYear()+100*today.getMonth()+100+today.getDate();var birthday=parseInt($scope.userModel.birthday.replace(/-/g,""));return Math.floor((today-birthday)/1e4)+"\u624d"},$scope.moveMessage=function(){$location.path("/message"),$("#modal-profile").modal("hide")},$scope.selectTab=function(tabKbn){$scope.tabKbn=tabKbn},$scope.getOkMsg=function(workPropose){if(void 0==workPropose.ok_flg||void 0==workPropose.user_id||void 0==workPropose.user_name||"1"!=workPropose.ok_flg)return"";var ret='<a href="employer/'+String(workPropose.user_id)+'">'+workPropose.user_name+"</a>\u3055\u3093\u304c\u3042\u306a\u305f\u306e\u63d0\u6848\u306b\u540c\u610f\u3057\u307e\u3057\u305f\u3002<br />";return ret+='<a href="message/target/'+String(workPropose.msg_id)+'">\u540c\u610f\u30e1\u30c3\u30bb\u30fc\u30b8</a>\u306a\u3069\u3092\u3054\u78ba\u8a8d\u9802\u304d\u3001\u76f4\u63a5\u3084\u308a\u53d6\u308a\u306e\u4e0a\u3001\u304a\u4ed5\u4e8b\u3092\u9032\u3081\u3066\u304f\u3060\u3055\u3044\u3002'},$(".date").unbind(),$(".date").on("dp.change",function(){$scope.userModel.birthday=$(".date").children('input[type="text"]').val(),"$apply"!=$scope.$root.$$phase&&"$digest"!=$scope.$root.$$phase&&$scope.$apply()}),$(".date").children('input[type="text"]').blur(function(){$scope.userModel.birthday=$(".date").children('input[type="text"]').val(),"$apply"!=$scope.$root.$$phase&&"$digest"!=$scope.$root.$$phase&&$scope.$apply()}),void 0!=$routeParams.rId){switch($routeParams.rId){case"1":$("#my-basic-info-tab").click();break;case"2":$("#my-profile-tab").click();break;case"3":$("#my-entry-tab").click();break;case"4":$("#my-recruit-tab").click();break;case"5":$("#my-message-tab").click()}return void($scope.tabKbn=Number($routeParams.rId))}$scope.hideProgressModal()}]);