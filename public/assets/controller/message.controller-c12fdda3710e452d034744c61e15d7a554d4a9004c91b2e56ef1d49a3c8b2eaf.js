"use strict";app.controller("MessageCtrl",["$scope","$controller","$timeout","$interval","$routeParams","$location","$log","userModel","usersModel","messagesModel","messageModel","searchMessageModel","searchUserModel","userService","messageService","notificationService",function($scope,$controller,$timeout,$interval,$routeParams,$location,$log,userModel,usersModel,messagesModel,messageModel,searchMessageModel,searchUserModel,userService,messageService,notificationService){$controller("AbstractCtrl",{$scope:$scope}),$log.debug("MessageCtrl Start"),$scope.messages=messagesModel.messages.get(),$scope.message=messageModel.message.get(),$scope.users=usersModel.users.get(),$scope.searchMessage=searchMessageModel.searchMessage.get(),$scope.searchUser=searchUserModel.searchUser.get(),$scope.selectedUser=null,$scope.errors=null,$scope.displayMessages="",$scope.errorsSend=null,$scope.displaySendMessages="",$scope.getMessageList=function(search){messageService.getMessages(search).success(function(data){$scope.messages=data,-1!=$location.path().indexOf("target")&&$timeout(function(){$("#target"+$routeParams.rId).click();var offset=$("#target"+$routeParams.rId).offset(),myTop=offset.top;$("body").animate({scrollTop:myTop-82},"slow")},0)}).error(function(){})},$scope.getMypageUser=function(){userService.getMypageUser().success(function(data){userModel.user.set(data.user),$scope.userModel=userModel.user.get()}).error(function(){})},$scope.insertMessage=function(detail,message){message.errors=null,message.displayMessages="",message.item_id=detail.item_id,message.parent_id=detail.id,$scope.userModel=userModel.user.get(),message.receive_user_id=detail.receive_user_id!=$scope.userModel.id?detail.receive_user_id:detail.send_user_id,message.send_user_id=$scope.userModel.id,$scope.showProgressModal(),messageService.insertMessage(message).success(function(data){$scope.hideProgressModal(),detail.details.unshift(data),message.errors=data,message.displayMessages="",message.content=""}).error(function(data){$scope.hideProgressModal();var messages=[];message.errors=data,$scope.setErrorMessage(data.content,"\u30e1\u30c3\u30bb\u30fc\u30b8",messages),message.displayMessages=$scope.getMessage(messages)})},$scope.getUserList=function(search){$scope.errorsSend=null,$scope.selectedUser=null,$scope.displaySendMessages="",userService.getUsers(search).success(function(data){$scope.users=data,angular.forEach($scope.users,function(user){(void 0==user.img_path||null==user.img_path||""==user.img_path)&&(user.img_path="/assets/person.jpg")})}).error(function(data){var messages=[];$scope.users=[],$scope.errorsSend=data,$scope.setErrorMessage(data.error_message,"",messages),$scope.displaySendMessages=$scope.getMessage(messages)})},$scope.insertMessageThread=function(selectedUser){$scope.errorsSend=null,$scope.displaySendMessages="";var message=messageModel.message.getInitModel();$scope.userModel=userModel.user.get(),message.send_user_id=$scope.userModel.id,message.receive_user_id=selectedUser.user_id,message.title=selectedUser.title,message.content=selectedUser.content,$scope.showProgressModal(),messageService.insertMessage(message).success(function(data){$scope.hideProgressModal(),(void 0==$scope.messages||null==$scope.messages)&&($scope.messages=[]),$scope.messages.unshift(data),$("#modal-message").modal("hide")}).error(function(data){$scope.hideProgressModal();var messages=[];$scope.errorsSend=data,$scope.setErrorMessage(data.title,"\u30bf\u30a4\u30c8\u30eb",messages),$scope.setErrorMessage(data.content,"\u30e1\u30c3\u30bb\u30fc\u30b8",messages),$scope.displaySendMessages=$scope.getMessage(messages)})},$scope.getEmployer=function(){userService.getUser($routeParams.rId).success(function(data){void 0!=data&&void 0!=data.content&&(data.content=""),$scope.selectedUser=data,$scope.openAddMessageDialog()}).error(function(){})},$scope.selectUser=function(userMessage){$scope.selectedUser=userMessage},$scope.isSelectUser=function(){return void 0==$scope.selectedUser||null==$scope.selectedUser?!1:!0},$scope.openAddMessageDialog=function(){$scope.userMessage=null,$("#modal-message").modal("show")},$scope.selectTitle=function(titleMsg){void 0!=titleMsg.notification_msg_count&&0!=titleMsg.notification_msg_count&&notificationService.deleteNotification(titleMsg.id,1).success(function(){$scope.getMypageUser(),titleMsg.notification_msg_count=0}).error(function(data){var messages=[];$scope.errorsSend=data,$scope.displaySendMessages=$scope.getMessage(messages)})};var stop;$("#modal-message").unbind(),$("#modal-message").on("shown.bs.modal",function(){stop=$interval(function(){$("#modal-message").modal("handleUpdate")},200)}),$("#modal-message").on("hidden.bs.modal",function(){angular.isDefined(stop)&&$interval.cancel(stop)}),$scope.getMypageUser(),$scope.getMessageList($scope.search,!1),void 0!=$routeParams.rId&&""!=$routeParams.rId&&-1==$location.path().indexOf("target")&&$scope.getEmployer()}]);