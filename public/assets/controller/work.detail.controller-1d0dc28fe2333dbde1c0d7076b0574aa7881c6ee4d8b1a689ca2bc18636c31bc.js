"use strict";app.controller("WorkDetailCtrl",["$scope","$controller","$routeParams","$log","workModel","workProposeModel","workCommentsModel","workCommentModel","workRecruitModel","workFavoriteModel","proposeOkMessageModel","itemService","itemProposeService","itemCommentService","itemFavoriteService",function($scope,$controller,$routeParams,$log,workModel,workProposeModel,workCommentsModel,workCommentModel,workRecruitModel,workFavoriteModel,proposeOkMessageModel,itemService,itemProposeService,itemCommentService,itemFavoriteService){return $controller("AbstractCtrl",{$scope:$scope}),$log.debug("WorkDetailCtrl Start"),$scope.errors=null,$scope.displayMessages="",$scope.displayProposeMessages="",$scope.displayCommentMessages="",$scope.workModel=workModel.work.get(),$scope.workProposeModel=workProposeModel.workPropose.get(),$scope.workCommentsModel=workCommentsModel.workComments.get(),$scope.workCommentModel=workCommentModel.workComment.get(),$scope.workFavoriteModel=workFavoriteModel.workFavorite.get(),$scope.$on("changedWork",function(){var work=workModel.work.get();work.id==$scope.workModel.id&&$scope.getWork()}),$scope.initCommon(),void 0==$routeParams.rId||""==$routeParams.rId?void $scope.displayCommonMsg(messageKbn.err_0004):($scope.getWork=function(){itemService.getItem($routeParams.rId).success(function(data){$scope.workModel=data.item,$scope.workModel.owner_flg=data.owner_flg,(void 0==$scope.workModel.price||""==$scope.workModel.price)&&($scope.workModel.price="\u7121\u3057"),(void 0==$scope.workModel.noki||""==$scope.workModel.noki)&&($scope.workModel.noki="\u7121\u3057"),(void 0==$scope.workModel.price_kbn_nm||""==$scope.workModel.price_kbn_nm)&&($scope.workModel.price_kbn_nm="\u6307\u5b9a\u7121\u3057"),(void 0==$scope.workModel.hour_price_kbn_nm||""==$scope.workModel.hour_price_kbn_nm)&&($scope.workModel.hour_price_kbn_nm="\u6307\u5b9a\u7121\u3057"),$scope.workProposeModel.payment_kbn=$scope.workModel.payment_kbn,$scope.getWorkPropose(),$scope.getWorkComment(),$scope.isLimitDays()&&($scope.displayProposeMessages="\u63d0\u6848\u306e\u52df\u96c6\u671f\u9593\u304c\u7d42\u4e86\u3057\u3066\u3044\u308b\u70ba\u3001\u63d0\u6848\u306f\u3067\u304d\u307e\u305b\u3093\u3002")}).error(function(){})},$scope.getWorkComment=function(){itemCommentService.getItemComments($routeParams.rId).success(function(data){return void 0==data||""==data?void($scope.workCommentsModel=[]):(workCommentsModel.workComments.set(data),void($scope.workCommentsModel=workCommentsModel.workComments.get()))}).error(function(data){$scope.displayMessages=data,$(window).scrollTop(0)})},$scope.getWorkPropose=function(){itemProposeService.getItemPropose($routeParams.rId).success(function(data){return void 0==data||""==data?($scope.workProposeModel=workProposeModel.workPropose.getInitModel(),void($scope.workProposeModel.payment_kbn=$scope.workModel.payment_kbn)):(workProposeModel.workPropose.set(data),$scope.workProposeModel=workProposeModel.workPropose.get(),void $("#btnEntry").click())}).error(function(){$scope.workProposeModel=workProposeModel.workPropose.getInitModel(),$scope.workProposeModel.payment_kbn=$scope.workModel.payment_kbn})},$scope.updateWorkPropose=function(workProposeModel){return void 0!=workProposeModel.ok_flg&&1==workProposeModel.ok_flg?($("#alert-message").html("\u3059\u3067\u306b\u5408\u610f\u3055\u308c\u3066\u3044\u308b\u63d0\u6848\u306e\u70ba\u3001\u7de8\u96c6\u3067\u304d\u307e\u305b\u3093\u3002"),void $("#modal-alert").modal("show")):($scope.errors=null,$scope.displayProposeMessages="",workProposeModel.item_id=$routeParams.rId,workProposeModel.noki=$("#workProposeModel_noki").val(),void(void 0==workProposeModel.id||""==workProposeModel.id?($scope.showProgressModal(),itemProposeService.insertItemPropose(workProposeModel).success(function(data){$scope.hideProgressModal(),$scope.workProposeModel.id=data.id,$scope.workModel.propose_count=$scope.workModel.propose_count+1,$scope.displayProposeMessages="\u63d0\u6848\u304c\u767b\u9332\u3055\u308c\u307e\u3057\u305f\u3002\u63d0\u6848\u3057\u305f\u4ed5\u4e8b\u306e\u5c65\u6b74\u306fMY\u30da\u30fc\u30b8\u3088\u308a\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002",$("body, html").animate({scrollTop:315},"slow")}).error(function(data){$scope.hideProgressModal();var messages=[];$scope.errors=data,$scope.setErrorMessage(data.payment_kbn,"\u652f\u6255\u65b9\u5f0f",messages),$scope.setErrorMessage(data.hour_price,"\u6642\u7d66",messages),$scope.setErrorMessage(data.week_hour_kbn,"\u4ed5\u4e8b\u91cf",messages),$scope.setErrorMessage(data.week_hour_period_kbn,"\u4e88\u5b9a\u671f\u9593",messages),$scope.setErrorMessage(data.price,"\u63d0\u6848\u91d1\u984d",messages),$scope.setErrorMessage(data.noki,"\u5b8c\u4e86\u4e88\u5b9a\u65e5",messages),$scope.setErrorMessage(data.content,"\u30e1\u30c3\u30bb\u30fc\u30b8",messages),$scope.setErrorMessage(data.error_message,"",messages),$scope.displayProposeMessages=$scope.getMessage(messages),$("body, html").animate({scrollTop:315},"slow"),$scope.showLoginDialogWhenNotLogin($scope.getWork)})):($("#modal-confirm-message").html("\u518d\u63d0\u6848\u3092\u884c\u3044\u307e\u3059\u3002\u3088\u308d\u3057\u3044\u3067\u3059\u304b\uff1f<br>\uff08\u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u306b\u30e1\u30c3\u30bb\u30fc\u30b8\u304c\u518d\u9001\u3055\u308c\u307e\u3059\uff09"),$scope.workProposeModel=workProposeModel,$scope.showCofirmDialog($scope.updateWorkProposeExec))))},$scope.showCofirmDialog=function(){$log.debug("showCofirmDialog"),$("#modal-confirm").modal("show"),$("#btnConfirmOk").unbind(),$("#btnConfirmOk").on("click",function(){$log.debug("showCofirmDialog OK"),$("#modal-confirm").modal("hide"),$scope.showProgressModal(),workProposeModel=$scope.workProposeModel,itemProposeService.updateItemPropose(workProposeModel).success(function(){$scope.hideProgressModal(),$scope.displayProposeMessages="\u63d0\u6848\u304c\u66f4\u65b0\u3055\u308c\u307e\u3057\u305f\u3002\u63d0\u6848\u3057\u305f\u4ed5\u4e8b\u306e\u5c65\u6b74\u306fMY\u30da\u30fc\u30b8\u3088\u308a\u78ba\u8a8d\u3067\u304d\u307e\u3059\u3002",$("body, html").animate({scrollTop:315},"slow")}).error(function(data){$scope.hideProgressModal();var messages=[];$scope.errors=data,$scope.setErrorMessage(data.payment_kbn,"\u652f\u6255\u65b9\u5f0f",messages),$scope.setErrorMessage(data.hour_price,"\u6642\u7d66",messages),$scope.setErrorMessage(data.week_hour_kbn,"\u4ed5\u4e8b\u91cf",messages),$scope.setErrorMessage(data.week_hour_period_kbn,"\u4e88\u5b9a\u671f\u9593",messages),$scope.setErrorMessage(data.price,"\u63d0\u6848\u91d1\u984d",messages),$scope.setErrorMessage(data.noki,"\u5b8c\u4e86\u4e88\u5b9a\u65e5",messages),$scope.setErrorMessage(data.content,"\u30e1\u30c3\u30bb\u30fc\u30b8",messages),$scope.setErrorMessage(data.error_message,"",messages),$scope.displayProposeMessages=$scope.getMessage(messages),$("body, html").animate({scrollTop:315},"slow"),$scope.showLoginDialogWhenNotLogin($scope.getWork)})})},$scope.doOkPropose=function(propose){var proposeOkMessage=proposeOkMessageModel.proposeOkMessage.getInitModel();proposeOkMessage.item_id=propose.item_id,proposeOkMessage.receive_user_id=propose.create_user_id,proposeOkMessageModel.proposeOkMessage.set(proposeOkMessage),$("#modal-propose-ok-message").modal("show")},$scope.getOkProposeString=function(okFlg){return void 0==okFlg||"1"!=String(okFlg)?"\u63d0\u6848\u306b\u5408\u610f\u3059\u308b":"\u63d0\u6848\u306b\u5408\u610f\u6e08\u307f"},$scope.insertComment=function(workCommentModel){$scope.showProgressModal(),$scope.displayCommentMessages="",workCommentModel.item_id=$routeParams.rId,itemCommentService.insertItemComment(workCommentModel).success(function(data){$scope.hideProgressModal(),$scope.displayCommentMessages="",workCommentModel.comment="",void 0==$scope.workCommentsModel&&($scope.workCommentsModel=[]),$scope.workCommentsModel.unshift(data);var offset=$("#question-list").offset();$("body, html").animate({scrollTop:offset.top-80},"slow")}).error(function(data){$scope.hideProgressModal();var messages=[];$scope.errors=data,$scope.setErrorMessage(data.comment,"\u8cea\u554f\u5185\u5bb9",messages),$scope.setErrorMessage(data.error_message,"",messages),$scope.displayCommentMessages=$scope.getMessage(messages);var offset=$("#question-list").offset();$("body, html").animate({scrollTop:offset.top-80},"slow"),$scope.showLoginDialogWhenNotLogin($scope.getWork)})},$scope.updateFavorite=function(){itemFavoriteService.updateItemFavorite($scope.workModel.own_favorite_flg,$scope.workModel.id).success(function(){1==$scope.workModel.own_favorite_flg?($scope.workModel.own_favorite_flg=0,$scope.workModel.favorite_count=$scope.workModel.favorite_count-1):($scope.workModel.own_favorite_flg=1,$scope.workModel.favorite_count=$scope.workModel.favorite_count+1)}).error(function(data){$scope.errors=data,$scope.showLoginDialogWhenNotLogin($scope.getWork)})},$scope.changeWorkKbn=function(){$scope.workProposeModel.work_kbn_nm=$scope.getWorkKbnName($scope.workProposeModel.work_kbn)},$scope.isProjectPayment=function(payment_kbn){if(void 0==payment_kbn){if($scope.workModel&&$scope.workModel.payment_kbn&&"122"==$scope.workModel.payment_kbn)return!0}else if("122"==payment_kbn)return!0;return!1},$scope.isProjectPaymentForPropose=function(){return $scope.workProposeModel&&$scope.workProposeModel.payment_kbn&&"122"==$scope.workProposeModel.payment_kbn?!0:!1},$scope.isPreview=function(){return void 0!=$scope.workModel&&void 0!=$scope.workModel.preview_flg&&"1"==$scope.workModel.preview_flg?!0:!1},$scope.initWorkModel=function(){$scope.workModel.work_kbn="",$scope.workModel.payment_kbn="1",$scope.workModel.price="",$scope.workModel.period_kbn="",$scope.workModel.noki="",$scope.workModel.hour_price_kbn="6",$scope.workModel.hour_price_kbn_nm="3,000\u5186 - 4,000\u5186 / \u6642\u9593",$scope.workModel.week_hour_kbn="1",$scope.workModel.week_hour_kbn_nm="10\u6642\u9593\u672a\u6e80",$scope.workModel.week_hour_period_kbn="3",$scope.workModel.week_hour_period_kbn_nm="1 - 3\u30f6\u6708",$scope.workModel.option_kbn="",$scope.workModel.limit_date="",$scope.workModel.title="",$scope.workModel.content="",$scope.workModel.work_kbn_nm="\u9078\u629e\u3055\u308c\u3066\u3044\u307e\u305b\u3093"},$scope.isOwner=function(){return void 0!=$scope.workModel.owner_flg&&"1"==String($scope.workModel.owner_flg)?!0:!1},$scope.isEdit=function(){return $scope.isOwner()&&!$scope.isPreview()?!0:!1},$scope.editWorkRecruit=function(){workRecruitModel.workRecruit.init(),workRecruitModel.workRecruit.set(JSON.parse(JSON.stringify($scope.workModel))),$("#modal-recruit").modal("show")},$scope.getItemFavoriteString=function(){return void 0==$scope.workModel||void 0==$scope.workModel.own_favorite_flg?"\u6c17\u306b\u306a\u308b\u30ea\u30b9\u30c8\u3078\u8ffd\u52a0":1==$scope.workModel.own_favorite_flg?void 0==$scope.workModel.favorite_count?"\u6c17\u306b\u306a\u308b\u30ea\u30b9\u30c8\u304b\u3089\u524a\u9664":"\u6c17\u306b\u306a\u308b\u30ea\u30b9\u30c8\u304b\u3089\u524a\u9664 ("+$scope.workModel.favorite_count+")":void 0==$scope.workModel.favorite_count?"\u6c17\u306b\u306a\u308b\u30ea\u30b9\u30c8\u3078\u8ffd\u52a0":"\u6c17\u306b\u306a\u308b\u30ea\u30b9\u30c8\u3078\u8ffd\u52a0 ("+$scope.workModel.favorite_count+")"},$scope.getEndDayString=function(limit_days){return void 0==limit_days?"":limit_days>0?"(\u6b8b\u308a"+limit_days+"\u65e5)":"(\u52df\u96c6\u7d42\u4e86)"},$scope.isLimitDays=function(){return void 0==$scope.workModel||void 0==$scope.workModel.limit_days?!0:$scope.workModel.limit_days>0?!1:!0},void $scope.getWork())}]);